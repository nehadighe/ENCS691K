"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.run = void 0;
const pull_backend_1 = require("../pull-backend");
const attach_backend_1 = require("../attach-backend");
const amplify_service_helper_1 = require("../amplify-service-helper");
const checkout_1 = require("./env/checkout");
const amplify_cli_core_1 = require("amplify-cli-core");
exports.run = async (context) => {
    const inputParams = amplify_service_helper_1.constructInputParams(context);
    const projectPath = process.cwd();
    if (amplify_cli_core_1.stateManager.currentMetaFileExists(projectPath)) {
        const { appId: inputAppId, envName: inputEnvName } = inputParams.amplify;
        const teamProviderInfo = amplify_cli_core_1.stateManager.getTeamProviderInfo(projectPath);
        const { envName } = amplify_cli_core_1.stateManager.getLocalEnvInfo(projectPath);
        const { AmplifyAppId } = teamProviderInfo[envName].awscloudformation;
        const localEnvNames = Object.keys(teamProviderInfo);
        if (inputAppId && AmplifyAppId && inputAppId !== AmplifyAppId) {
            context.print.error('Amplify appId mismatch.');
            context.print.info(`You are currently working in the amplify project with Id ${AmplifyAppId}`);
            throw new Error('Amplify appId');
        }
        if (inputEnvName) {
            if (inputEnvName === envName) {
                await pull_backend_1.pullBackend(context, inputParams);
            }
            else if (localEnvNames.includes(inputEnvName)) {
                context.parameters.options = {};
                context.parameters.first = inputEnvName;
                await checkout_1.run(context);
            }
            else {
                inputParams.amplify.appId = inputAppId;
                await attach_backend_1.attachBackend(context, inputParams);
            }
        }
        else {
            await pull_backend_1.pullBackend(context, inputParams);
        }
    }
    else {
        await attach_backend_1.attachBackend(context, inputParams);
    }
};
//# sourceMappingURL=pull.js.map